@{
    Layout = null;
    
    // CultureInfo for swedish currency print out 
    CultureInfo se = CultureInfo.CreateSpecificCulture("sv-SE");
}
@using TietoCRM.Models;
@using System.Globalization;

<div id="crm-pdf-offer-head">
    <p><strong id="Document_head">@Html.Raw(@ViewBag.CustomerOffer.Document_head)</strong></p>
    <div id="Page_head" >@Html.Raw(@ViewBag.CustomerOffer.Page_head)</div>
</div>
@if(ViewBag.Articles.Count > 0)
{
<div id="crm-pdf-offer-rows" class="">
    
    @{
        decimal discounts = 0;
        decimal ProductLicenseTotal = 0;
        decimal ProductMaintenanceTotal = 0;

        String previousSystem = "";
        String previousPriceType = "";
    }
    @foreach (dynamic article in ViewBag.Articles)
    {
        if(article.Discount_type == 1)
        {
            discounts += article.Price_category;
        }

        if (previousPriceType != article.Price_type)
        {
            previousPriceType = article.Price_type;
            <div class="crm-pdf-subheader_1" id="crm-pdf-module-rows-title">
                <table>
                    <tr>
                        <td>Produkter</td>
                        <td></td>
                        <td>Engångsbelopp</td>
                        <td>@article.Price_type</td>
                    </tr>
                </table>
            </div>
            <div class="large-divider"></div>
        }
        // Calculate total sums
        String License;
        String Maintenance;
        // Format currency
        if (article.Discount_type != 1)
        {
            License = string.Format(se, "{0:C2}", article.License).Replace(".", " ");
            Maintenance = string.Format(se, "{0:C2}", article.Maintenance).Replace(".", " ");
            ProductLicenseTotal += Convert.ToDecimal(article.License);
            ProductMaintenanceTotal += Convert.ToDecimal(article.Maintenance);
        }
        else
        {
            License = article.License + "%";
            Maintenance = "0 kr";
        }
        if (previousSystem != article.System)
        {
            <div class="crm-pdf-subrows_1">
                <table>
                    <tr>
                        <td>@article.System</td>
                    </tr>
                </table>
            </div>
        }
        <div class="crm-pdf-subrows_2">
            <table>
                <tr>
                    <td>@article.Classification</td>
                    <td>@article.Article_number</td>
                    <td>@article.Module</td>
                    <td>@License</td>
                    <td>@Maintenance</td>
                </tr>
            </table>
        </div>
        previousSystem = article.System;
    }
    @{
        if (discounts < -100)
        {
            discounts = -100;
        }
        // Format currency for total sums
        string ProductLicenseTotalFormated = string.Format(se, "{0:C2}", ProductLicenseTotal + ProductLicenseTotal*(decimal)discounts/100).Replace(".", " ");
        string ProductMaintenanceTotalFormated = string.Format(se, "{0:C2}", ProductMaintenanceTotal + ProductMaintenanceTotal * (decimal)discounts / 100).Replace(".", " ");
    }
    <span class="large-divider"></span>
    <div class="crm-pdf-subsum_1">
        <table>
            <tr>
                <td></td>
                <td>Summa Produkter:</td>
                <td>@ProductLicenseTotalFormated</td>
                <td>@ProductMaintenanceTotalFormated</td>
            </tr>
        </table>
    </div>
</div>
}
@if(ViewBag.EducationPortals.Count > 0)
{
<div id="crm-pdf-educational-portal-rows">
    <div class="crm-pdf-subheader_1" id="crm-pdf-educational-portal-rows-title">
        <table>
            <tr>
                <td>Lärportal</td>
                <td></td>
                <td></td>
                <td>Person/år</td>
            </tr>
        </table>
    </div>
    <div class="large-divider"></div>
    @{
        decimal EducationalPortalTotal = 0;
    }
    @foreach (dynamic article in ViewBag.EducationPortals)
    {
        String Maintenance = string.Format(se, "{0:C2}", article.Maintenance).Replace(".", " ");
        // Calculate total sums
        EducationalPortalTotal += Convert.ToDecimal(article.Maintenance);
        //view_Module module = new view_Module();
        //module.Select("Article_number = " + article.Article_number);

        // Format currency

        String License = string.Format(se, "{0:C2}", article.License).Replace(".", " ");
        <div class="crm-pdf-subrows_2">
            <table>
                <tr>
                    <td style="padding-left:0em">@article.Classification</td>
                    <td>@article.Article_number</td>
                    <td>@article.Module</td>
                    <td></td>
                    <td>@Maintenance</td>
                </tr>
            </table>
        </div>
    }
    @{
        // Format currency for total sums
        string EducationalPortalTotalFormated = string.Format(se, "{0:C2}", EducationalPortalTotal).Replace(".", " ");
    }
    <span class="large-divider"></span>
    <div class="crm-pdf-subsum_1">
        <table>
            <tr>
                <td></td>
                <td>Summa Lärportal:</td>
                <td></td>
                <td>@EducationalPortalTotalFormated</td>
            </tr>
        </table>
    </div>
</div>
}
       
@if(ViewBag.CustomerOffer._ConsultantRows.Count > 0)
{
@*-------------------------------------
Konsulttjänster
-------------------------------------*@
    <div id="crm-pdf-service-rows">
        <div class="crm-pdf-subheader_1">
            <table>
                <tr>
                    <td>Konsulttjänster/Teknikinstallation</td>
                    <td>Antal</td>
                    <td>Àpris</td>
                    <td>Summa</td>
                </tr>
            </table>
        </div>
        <div class="large-divider"></div>
        @{

    decimal ServicesTotal = 0;
        }
        @foreach (view_ConsultantRow cr in ViewBag.CustomerOffer._ConsultantRows)
        {
            // Featch Service from DB
            view_Service Service = new view_Service();
            Service.Select("Code = " + cr.Code);
            if (!String.IsNullOrEmpty(cr.Alias))
            {
                Service.Description = cr.Alias;
            }
            // Calculate total sums
            ServicesTotal += Convert.ToDecimal(cr.Total_price);


            // Format currency
            string Price = string.Format(se, "{0:C2}", cr.Total_price / cr.Amount).Replace(".", " ");
            string TotalPrice = string.Format(se, "{0:C2}", cr.Total_price).Replace(".", " ");
            <div class="crm-pdf-subrows_1">
                <table>
                    <tr>
                        <td>@Service.Description</td>
                        <td>@cr.Amount</td>
                        <td>@Price</td>
                        <td>@TotalPrice</td>
                    </tr>
                </table>
            </div>
        }
        @{
        // Format currency for total sums
        string ServicesTotalFormated = string.Format(se, "{0:C2}", ServicesTotal).Replace(".", " ");
        }
        <span class="large-divider"></span>
        <div class="crm-pdf-subsum_1">
            <table>
                <tr>
                    <td></td>
                    <td>Summa Tjänster: </td>
                    <td></td>
                    <td>@ServicesTotalFormated</td>
                </tr>
            </table>
        </div>
    </div>
 }
