<div class="crm-bg">
    <div class="row">
        <div class="col-md-6 crm-widget-dashboard">
            <div class="panel panel-default crm-widget-dashboard">
                <div class="panel-heading">
                    Counters
                    <span id="crm-widget-refresh-all" class="pull-right">
                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                    </span>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-6 col-md-4">
                            <div id="open-offers" class="panel panel-default crm-widget">
                                <div class="panel-heading">Pending Offers</div>
                                <div class="panel-body">
                                    <span class="glyphicon glyphicon-check" aria-hidden="true"></span>
                                    <span class="widget-data"> </span>
                                    <div style="display: none" class="crm-loading">
                                        <img src="~/Content/img/crm-loading.gif" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="sent-contracts" class="col-xs-6 col-md-4">
                            <div class="panel panel-default crm-widget">
                                <div class="panel-heading">Sent Contracts</div>
                                <div class="panel-body">
                                    <span class="glyphicon glyphicon-check" aria-hidden="true"></span>
                                    <span class="widget-data"> </span>
                                    <div style="display: none" class="crm-loading">
                                        <img src="~/Content/img/crm-loading.gif" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6 col-md-4">
                            <div id="expiring-contracts" class="panel panel-default crm-widget">
                                <div class="panel-heading">Expiring Contracts</div>
                                <div class="panel-body">
                                    <span class="glyphicon glyphicon-check" aria-hidden="true"></span>
                                    <span class="widget-data"> </span>
                                    <div style="display: none" class="crm-loading">
                                        <img src="~/Content/img/crm-loading.gif" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-default crm-widget-dashboard">
                <div class="panel-heading">
                    Information Messages
                    <span id="info-refresh-all" class="pull-right">
                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                    </span>
                </div>
                <div class="panel-body crm-info-container">
                    <ul class="crm-info-list">
                        <li style="display: none" class="crm-loading">
                            <img src="~/Content/img/crm-loading.gif" />
                        </li>
                        <li class="crm-empty-list">
                            As for now there are no messasges to show.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6 crm-widget-dashboard">
        </div>
    </div>
</div>



<script>
    var handleLoadingIcon = function($widget, action)
    {
        var $panelBody = $widget.find('.panel-body');
        var $laodingContainer = $widget.find('.crm-loading')
        if(action == 'show')
        {
            $panelBody.find('span').hide();
            $laodingContainer.show();
        }
        else {
            $panelBody.find('span').show();
            $laodingContainer.hide();
        }
    }
    var getStatisticsValue = function(url, $widget)
    {
        var $widgetData = $widget.find('.widget-data');
        //console.log($widgetData);
        $.ajax({
            "url": url,
            "type": "POST",
            "beforeSend": function(){
                handleLoadingIcon($widget, "show");
            },
            "success": function (data) {
                console.log($widgetData);
                $widgetData.html(data);
                handleLoadingIcon($widget, "hide");
            },
            "error": function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
                handleLoadingIcon($widget, "hide");
                triggerAlert("Update failed. Please check your internet connection.", "warning");
            }
        });
    }
    var handleEmptyInfoMesg = function(show)
    {
        var $container = $('.crm-empty-list');
        if (show == true || show == 'show')
        {
            $container.show(); console.log('showing');
        }         
        else
            $container.hide();

        return $container;
    }
    var getAllInformation =  function(StatisticsRefresh)
    {
        var StatisticsRefresh = StatisticsRefresh === true ? StatisticsRefresh : false;
        console.log(StatisticsRefresh);

        var $infoList = $('.crm-info-list');
        var $laodingContainer = $infoList.find('.crm-loading');
        var $emptyMsg = $('.crm-empty-list');
        $infoList.html($laodingContainer);
        $infoList.append($emptyMsg);

        $.ajax({
            "url": "/Home/GetAllInformation/",
            "type": "POST",
            "dataType": "json",
            "beforeSend": function () {
                $laodingContainer.show();
                handleEmptyInfoMesg('hide');
            },
            "success": function (data) {
                setTimeout(function () {
                    if (data.length == 0 || data == "" || typeof data == 'undefined')
                    {
                        handleEmptyInfoMesg('show');
                        $laodingContainer.hide();
                        if (StatisticsRefresh) {
                            getAllStatistics();
                        }
                   
                    }
                    else
                    {
                        handleEmptyInfoMesg('hide');
                   
                        $laodingContainer.hide();
                        $(data).each(function () {
                            var infoObj = this;
                            var infoHtml = createInformationHtml(infoObj);
                            $infoList.append(infoHtml);
                               
                        })
                        if (StatisticsRefresh) {
                            getAllStatistics();
                        }
                    }  
                }, 500);
            },
            "error": function (jqXHR, textStatus, errorThrown) {
                $laodingContainer.hide();
                triggerAlert("Update failed. Please check your internet connection.", "warning");
            }
        });
    }

    var createInformationHtml = function(infoObj)
    {
        var rawHtml = "<li class='info-item'>                                               \
                           <div class='panel panel-default crm-widget'>                     \
                               <div class='panel-heading info-title'>                       \
                                   <span class='info-title-text'></span>                    \
                                   <span class='glyphicon pull-right'></span>               \
                               </div>                                                       \
                               <div class='panel-body info-message'></div>                  \
                               <div class='panel-footer'>                                   \
                                   <div class='info-author'></div>                          \
                                   <div class='info-updated'>Updated: <span></span></div>   \
                               </div>                                                       \
                           </div>                                                           \
                       </li>";
        var $htmlObj = $(rawHtml);
        if (infoObj.Type == "Warning")
        {
            $htmlObj.addClass('info-warning');
            $htmlObj.find('.glyphicon').addClass('glyphicon-warning-sign');
        }
        else
        {
            $htmlObj.addClass('info-normal');
            $htmlObj.find('.glyphicon').addClass('glyphicon-info-sign');
        }
        $htmlObj.attr("data-info-id", infoObj._ID);
        $htmlObj.find('.info-title-text').html(infoObj.Title);
        $htmlObj.find('.info-message').html(infoObj.Message);
        $htmlObj.find('.info-author').html(infoObj.AuthorFullName);
        $htmlObj.find('.info-updated span').html(infoObj.Updated);
        return $htmlObj;
    }

    var $openOffersWidget = $('#open-offers');
    var $sentContractsWidget = $('#sent-contracts');
    var $expiringContractsWidget = $('#expiring-contracts');

    var getAllStatistics = function () {
        getStatisticsValue("/Home/GetAmountOpenOffers/", $openOffersWidget);
        getStatisticsValue("/Home/GetAmountSentContracts/", $sentContractsWidget);
        getStatisticsValue("/Home/GetAmountExpiringContracts/", $expiringContractsWidget);
    }

    $(document).ready(function () {

        $('#crm-widget-refresh-all').click(getAllStatistics);
        $('#info-refresh-all').click(getAllInformation);
  
        
        getAllInformation(true);
        
        
    });
</script>
