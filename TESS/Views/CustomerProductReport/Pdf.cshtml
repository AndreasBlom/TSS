@{
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
    bool showDesc = false;
    if (Request.Params["showDesc"] != null)
    {
        if (Request.Params["showDesc"] == "1")
        {
            showDesc = true;
        }
    }
}
@using TietoCRM.Models;
@{ 
    int contractCount = ((IEnumerable<dynamic>)ViewBag.MainContracts).Count()-1;
    string pagebreak = "";
}
@foreach (view_Contract mainContract in ViewBag.MainContracts)
{
    if (contractCount > 0)
    {
        pagebreak = "page-break-after:always";
    }
    else
    {
        pagebreak = "page-break-after:avoid";
    }

    <div style=@pagebreak>
        <table width="100%">
            <tr>
                <td>
                    <div style="font-size:16px">
                        <strong>@mainContract.Customer</strong>
                    </div>
                </td>
                <td>
                    <div style="font-size:12px; text-align:right">
                        <strong>Avtalsbeteckning: </strong>@mainContract.Main_contract_id
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div style="font-size:12px">
                        @DateTime.Now.ToShortDateString()
                    </div>
                </td>
                <td>
                    <div style="font-size:12px; text-align:right">
                        <strong>Avtalsperiod: </strong>
                        @if (mainContract.Valid_from != null)
                        {
                            @(mainContract.Valid_from.Value.ToShortDateString() + " ");
                        }
                        -
                        @if (@mainContract.Valid_through != null)
                        {
                            @(" " + mainContract.Valid_through.Value.ToShortDateString());
                        }
                    </div>
                </td>
            </tr>
        </table>
        <br />
        <br />

        <div style="font-size:25px">
            Modulförteckning
        </div>
        <br />
        @foreach (String pName in mainContract._OrderedSystemNames)
        {
            var rubrik = pName.Split(new char[] { '#' })[1];
            <div class="crm-print-block">
                <h2>@rubrik</h2>
                <table class="table table-striped table-bordered cpr-table">
                    @foreach (System.Reflection.PropertyInfo PropertyInfo in ViewBag.Properties)
                    {
                        String PropertyName = PropertyInfo.Name.Replace("_", " ");
                        if (!ViewBag.IgnoredPropertiesExtended.Contains(PropertyInfo.Name))
                        {
                            var newPropertyName = "";
                            if (PropertyInfo.Name == "Article_number") { newPropertyName = "Artikelnr"; }
                            if (PropertyInfo.Name == "Module") { newPropertyName = "Modul"; }
                            if (PropertyInfo.Name == "Classification") { newPropertyName = "Indelning"; }
                            if (PropertyInfo.Name == "Valid_through" && ViewBag.ShowValidThroughColumn) { newPropertyName = "Giltig till"; }
                            if (PropertyInfo.Name == "Contract_id" && ViewBag.ShowContractIdColumn) { newPropertyName = "Kontraktsnr"; }

                            if (!string.IsNullOrEmpty(newPropertyName))
                            {
                                <th>@newPropertyName</th>
                            }
                        }
                    }
                    @foreach (Dictionary<String, object> CPR in mainContract._CustomerProductRowsSorted)
                    {
                        if ((String)CPR["System"] == rubrik && (String)CPR["Status"] == "Giltigt")
                        {
                                <tr class="">
                                    @foreach (KeyValuePair<String, object> dic in CPR)
                                    {
                                        if (!ViewBag.IgnoredPropertiesExtended.Contains(dic.Key))
                                        {
                                            if (dic.Key == "Valid_through" && ViewBag.ShowValidThroughColumn)
                                            {
                                                if (dic.Value != null)
                                                {
                                                    <td>@((Convert.ToDateTime(dic.Value)).ToString("yyyy-MM-dd"))</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }
                                            }
                                            else if ((String)dic.Key == "Module")
                                            {
                                                if (String.IsNullOrEmpty((String)CPR["Alias"]))
                                                {
                                                    <td>
                                                        <strong>@CPR["Module"]</strong>
                                                        @if (showDesc)
                                                        {
                                                            foreach (view_Module module in mainContract._MatchedModules)
                                                            {
                                                                if (module.Article_number.ToString() == CPR["Article_number"].ToString())
                                                                {
                                                                    <div>@module.Description</div>
                                                                }
                                                            }
                                                        }

                                                    </td>
                                                }
                                                else
                                                {
                                                    <td>
                                                        <strong>@CPR["Alias"]</strong>
                                                        @if (showDesc)
                                                        {
                                                            foreach (view_Module module in mainContract._MatchedModules)
                                                            {
                                                                if (module.Article_number.ToString() == CPR["Article_number"].ToString())
                                                                {
                                                                    <div>@module.Description</div>
                                                                }
                                                            }
                                                        }
                                                    </td>
                                                }

                                            }
                                            else if (dic.Key == "Article_number")
                                            {
                                                if (dic.Value != null)
                                                {
                                                    <td>@dic.Value</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }

                                            }
                                            else if (dic.Key == "Classification")
                                            {
                                                if (dic.Value != null)
                                                {
                                                    <td>@dic.Value</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }

                                            }
                                            else if (dic.Key == "Contract_id" && ViewBag.ShowContractIdColumn)
                                            {
                                                if (dic.Value != null)
                                                {
                                                    <td>@dic.Value</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }

                                            }
                                        }
                                    }
                                </tr>
                        }
                        else
                        {
                            // break;
                        }
                    }

                </table>
            </div>
        }
    </div>
    contractCount--;
}

